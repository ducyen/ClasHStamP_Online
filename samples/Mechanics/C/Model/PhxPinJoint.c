/* File generated by Đức's ClasHStamP */
#define __PhxPinJoint_INTERNAL__
#include "CommonInclude.h"
#include "PhxPinJoint.h"
#include "PhxSprite.h"                                          
/** @public @memberof PhxPinJoint */
static void PhxPinJoint_apply(
    PhxPinJoint* pPhxPinJoint,
    Sprite* target
){
    cpSpace *space = ObjsBuilder_getPhxSpace();
    PhxSprite* pTarget = ( PhxSprite* )target;
    cpBody* pBodyTgt = PhxSprite_getBody( pTarget );
    cpBody* pBodySrc;
    if( pPhxPinJoint->m_source == null ){
        pBodySrc = cpSpaceGetStaticBody( space );
    }else{
        PhxSprite* pSource = ( PhxSprite* )( *pPhxPinJoint->m_source );
        pBodySrc = PhxSprite_getBody( pSource );
    }

    cpVect anchorSrc = cpvzero;
    if( pPhxPinJoint->m_anchorSrc != null){
        SDL_Rect* pRect = Sprite_getRect( *pPhxPinJoint->m_anchorSrc );
        cpBB bbSource = cpBBNew( pRect->x, ObjsBuilder_getScreenHeight() - pRect->y - pRect->h, pRect->x + pRect->w, ObjsBuilder_getScreenHeight() - pRect->y );
        anchorSrc = cpBodyWorldToLocal( pBodySrc, cpBBCenter( bbSource ) );
    }

    cpVect anchorTgt = cpvzero;
    if( pPhxPinJoint->m_anchorTgt != null){
        SDL_Rect* pRect = Sprite_getRect( *pPhxPinJoint->m_anchorTgt );
        cpBB bbTarget = cpBBNew( pRect->x, ObjsBuilder_getScreenHeight() - pRect->y - pRect->h, pRect->x + pRect->w, ObjsBuilder_getScreenHeight() - pRect->y );
        anchorTgt = cpBodyWorldToLocal( pBodyTgt, cpBBCenter( bbTarget ) );
    }
    pPhxPinJoint->m_cpJoint = cpSpaceAddConstraint(
        space, 
        cpPinJointNew(
            pBodySrc, 
            pBodyTgt, 
            anchorSrc, 
            anchorTgt
        )
    );
} /* PhxPinJoint_apply */

PhxJoint* PhxPinJoint_Copy( PhxPinJoint* pPhxPinJoint, const PhxPinJoint* pSource ){
    PhxJoint_Copy( ( PhxJoint* )pPhxPinJoint, ( PhxJoint* )pSource );
    return ( PhxJoint* )pPhxPinJoint;
}
const PhxJointVtbl gPhxPinJointVtbl = {
    .papply                      = PhxPinJoint_apply,
};
